<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>English Quest â€” Dubai Kids</title>
  <style>
    :root{
      --bg:#0b1220; --card:#121f3f; --card2:#0f1a35;
      --txt:#eaf0ff; --mut:rgba(255,255,255,.75);
      --line:rgba(255,255,255,.10); --ok:#22c55e; --bad:#fb7185; --pri:#1e3a8a;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial;
    }
    body{margin:0;background:var(--bg);color:var(--txt);}
    header{position:sticky;top:0;background:#101a33;border-bottom:1px solid var(--line);z-index:10;}
    .wrap{max-width:1100px;margin:0 auto;padding:14px 14px;}
    h1{margin:0;font-size:18px;}
    h2{margin:0 0 8px;font-size:16px;}
    h3{margin:0 0 8px;font-size:14px;}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center;}
    .grid{display:grid;grid-template-columns:1fr;gap:12px;}
    @media(min-width:980px){.grid{grid-template-columns:1.3fr .7fr;}}
    .card{background:var(--card);border:1px solid var(--line);border-radius:16px;padding:14px;}
    .card2{background:var(--card2);border:1px solid var(--line);border-radius:16px;padding:12px;}
    .pill{padding:6px 10px;border-radius:999px;background:rgba(255,255,255,.08);font-size:12px;}
    .mut{color:var(--mut);font-size:13px;line-height:1.35;}
    button, input, select{
      border-radius:12px;border:1px solid rgba(255,255,255,.16);
      background:var(--card2);color:var(--txt);padding:10px 12px;
    }
    button{cursor:pointer}
    button.primary{background:var(--pri);}
    button.good{background:rgba(34,197,94,.15);border-color:rgba(34,197,94,.35);}
    button.bad{background:rgba(251,113,133,.15);border-color:rgba(251,113,133,.35);}
    a{color:#a8c7ff;text-decoration:none}
    a:hover{text-decoration:underline}
    .hr{border:none;border-top:1px solid var(--line);margin:12px 0;}
    .progress{height:12px;border-radius:999px;background:rgba(255,255,255,.08);overflow:hidden;}
    .bar{height:100%;width:0%;background:var(--ok);}
    .tiles{display:grid;grid-template-columns:repeat(2,1fr);gap:10px;}
    @media(min-width:700px){.tiles{grid-template-columns:repeat(4,1fr);}}
    .tile{background:rgba(255,255,255,.06);border:1px solid var(--line);border-radius:16px;padding:12px;cursor:pointer;}
    .tile:hover{background:rgba(255,255,255,.09);}
    .kpi{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;}
    .kpi .box{background:rgba(255,255,255,.06);border:1px solid var(--line);border-radius:14px;padding:10px;}
    .tag{font-size:11px;opacity:.85}
    .big{font-size:18px;font-weight:700}
    .msgOk{color:var(--ok)}
    .msgBad{color:var(--bad)}
    .list{margin:8px 0 0;padding-left:18px;}
    .hidden{display:none}
    /* ===== MAP / POIs (Fortnite-style) ===== */
.poi{
  position:absolute;
  transform: translate(-50%, -100%);
  cursor:pointer;
  user-select:none;
  padding:8px 10px;
  border-radius:14px;
  background: rgba(0,0,0,.28);
  border: 1px solid rgba(255,255,255,.18);
  backdrop-filter: blur(6px);
  font-size:12px;
}
.poi:hover{
  background: rgba(0,0,0,.40);
}
.poi.locked{
  opacity:.55;
}
.poi .name{
  font-weight:700;
}
.poi .badge{
  margin-left:6px;
}
.poiThumb{
  width:100%;
  max-height:140px;
  object-fit:cover;
  border-radius:12px;
  border:1px solid rgba(255,255,255,.12);
  margin-top:8px;
}
/* Map drag UX (Google-Maps feel) */
#mapViewport{
  cursor: grab;
  overscroll-behavior: contain;
  touch-action: none; /* permite arrastrar en mobile */
}
#mapViewport.dragging{ cursor: grabbing; }

    /* Audio buttons */
.audio-controls{
  display:flex;
  gap:10px;
  align-items:center;
  margin:6px 0;
}
.audio-controls button{
  font-size:18px;
  padding:8px 12px;
  border-radius:12px;
  cursor:pointer;
}
    
  </style>
</head>
<body>
<header>
  <div class="wrap row" style="justify-content:space-between;">
    <div class="row">
      <h1>English Quest â€” Dubai Kids</h1>
      <span class="pill" id="today"></span>
    </div>
    <div class="row">
      <button id="btnHome">ğŸ  My World</button>
      <button id="btnMap">ğŸ—ºï¸ Map</button>
      <button id="btnArcade">ğŸ® Games</button>
      <button id="btnParents">ğŸ‘¨â€ğŸ‘©â€ğŸ‘§ Parents</button>

    </div>
  </div>
</header>

<div class="wrap grid">
  <!-- MAIN -->
  <main class="card">
    <!-- LOGIN -->
    <section id="viewLogin" class="card2">
      <h2>ğŸ¯ Enter the Game</h2>
      <div class="mut">Usa tu cÃ³digo para jugar y aprender inglÃ©s.</div>
      <div class="row" style="margin-top:10px;">
        <input id="code" placeholder="Code (ej: MATIAS123)" style="min-width:220px;">
        <button class="primary" id="btnEnter">ğŸš€ Start</button>
        <span class="pill" id="loginHint">â­ Ask your parent for your code</span>
      </div>
      <div class="mut">
ğŸ¯ <b>Cada niÃ±o es diferente.</b> AquÃ­ no importa solo la edad, sino cÃ³mo usa el inglÃ©s.<br><br>

<b>GuÃ­a rÃ¡pida por edad:</b><br>
â€¢ <b>6â€“8 aÃ±os</b>: phonics (sonidos) + palabras.<br>
â€¢ <b>8â€“10 aÃ±os</b>: frases cortas + comprensiÃ³n (listening).<br>
â€¢ <b>10â€“15 aÃ±os</b>: misiones reales (school, city, friends).<br><br>

<b>Â¿No sabes el nivel?</b> Pronto habrÃ¡ una <b>prueba corta</b> (tipo juego) para recomendar por dÃ³nde empezar.

        <hr style="margin:10px 0; opacity:.3">
<b>Tip para papÃ¡s:</b> Si tu hijo ya entiende instrucciones simples en inglÃ©s (ej: â€œsit downâ€, â€œopen your bookâ€), puede empezar directamente en <b>misiones</b>.

      </div>
     


.audio-controls .chip{
  font-size:18px;
  padding:8px 12px;
  border-radius:12px;
  cursor:pointer;
}

    </section>

    <!-- MAP (Fortnite-style) -->
<section id="viewMap" class="hidden">
  <div class="row" style="justify-content:space-between; align-items:flex-start;">
    <div>
      <h2>ğŸ—ºï¸ World Map</h2>
      <div class="mut">Select a location (POI) to start missions. Locked areas unlock as your level increases.</div>
    </div>

    <div class="row">
      <button id="zoomOut">â–</button>
      <span class="pill" id="zoomLabel">100%</span>
      <button id="zoomIn">â•</button>
    </div>
  </div>

  <hr class="hr">

  <div class="row" style="align-items:stretch; gap:12px;">
    <!-- MAP CANVAS -->
    <div class="card2" style="flex:1; min-width:260px;">
      <div class="row" style="justify-content:space-between; margin-bottom:8px;">
        <div class="mut"><b>Dubai + Abu Dhabi</b> (Fortnite-style POIs)</div>
        <button id="btnAddHome">ğŸ“¸ Add My Home</button>
      </div>

      <div id="mapViewport" style="height:420px; overflow:auto; border-radius:16px; border:1px solid rgba(255,255,255,.10);">
        <div id="mapCanvas" style="position:relative; width:1100px; height:700px; transform-origin: top left;">
          <!-- Background grid (simple, fast) -->
          <div style="position:absolute; inset:0; background:
            radial-gradient(circle at 20% 30%, rgba(30,58,138,.45), transparent 45%),
            radial-gradient(circle at 70% 60%, rgba(34,197,94,.18), transparent 45%),
            linear-gradient(135deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
            ">
          </div>

          <!-- â€œSeaâ€ / edges -->
          <div style="position:absolute; left:0; top:0; width:100%; height:100%;
            background-image: linear-gradient(rgba(255,255,255,.07) 1px, transparent 1px),
                              linear-gradient(90deg, rgba(255,255,255,.07) 1px, transparent 1px);
            background-size: 44px 44px;
            opacity:.35;">
          </div>

          <!-- POIs injected by JS -->
          <div id="poiLayer" style="position:absolute; inset:0;"></div>
        </div>
      </div>

      <!-- Hidden file input -->
      <input id="homePhotoInput" type="file" accept="image/*" style="display:none;">
    </div>

    <!-- SIDE PANEL -->
    <div class="card2" style="width:330px; min-width:280px;">
      <h3>ğŸ“ Location</h3>
      <div id="poiPanel" class="mut">Tap a POI on the map to see details.</div>
      <hr class="hr">
      <div class="mut">
        <b>Legend</b><br>
        âœ… Open â€¢ ğŸ”’ Locked â€¢ â­ Recommended Today
      </div>
    </div>
  </div>
</section>

    <!-- HOME / MAP -->
    <section id="viewHome" class="hidden">
      <div class="row" style="justify-content:space-between;">
        <div>
          <h2 id="who">Bienvenido</h2>
          <div class="mut">Mapa de mundos (misiones). Completa una misiÃ³n diaria para ganar XP.</div>
        </div>
        <div class="row">
          <span class="pill" id="levelPill">Level 1</span>
          <button id="btnLogout">Salir</button>
        </div>
      </div>

      <div class="kpi" style="margin-top:10px;">
        <div class="box"><div class="tag">XP</div><div class="big" id="kXP">0</div></div>
        <div class="box"><div class="tag">Streak (dÃ­as)</div><div class="big" id="kStreak">0</div></div>
        <div class="box"><div class="tag">Misiones hoy</div><div class="big" id="kToday">0/1</div></div>
      </div>

      <hr class="hr">

      <h3>ğŸŒ Mundos (elige una misiÃ³n)</h3>
      <div class="tiles" id="worlds"></div>

      <hr class="hr">

      <div class="row">
        <button class="primary" id="btnDaily">ğŸ§­ Todayâ€™s Mission</button>
        <button id="btnReview">ğŸ” Practice</button>
      </div>

      <div id="panel" style="margin-top:12px;"></div>
    </section>

    <!-- ARCADE -->
    <section id="viewArcade" class="hidden">
      <h2>ğŸ® Arcade</h2>
      <div class="mut">Juegos cortos para practicar. (RÃ¡pido + divertido + efectivo)</div>
      <hr class="hr">
      <div class="row">
        <button onclick="arcadeMatch()">Match</button>
        <button onclick="arcadeQuiz()">Quick Quiz</button>
        <button onclick="arcadeListening()">Listening Bingo</button>
      </div>
      <div id="arcade" style="margin-top:12px;"></div>
    </section>

    <!-- PARENTS -->
    <section id="viewParents" class="hidden">
      <h2>ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦ Panel para papÃ¡s</h2>
      <div class="mut">Este panel lee el progreso guardado en el dispositivo. (Luego podemos hacer versiÃ³n con base de datos.)</div>
      <hr class="hr">
      <div id="parents"></div>
    </section>
  </main>

  <!-- SIDEBAR -->
  <aside class="card">
    <h2>Fuentes reales (recursos)</h2>
    <div class="mut">Usamos enlaces oficiales. Esto es importante para que sea serio y confiable.</div>
    <ul class="list">
      <li><a target="_blank" rel="noreferrer" href="https://learnenglishkids.britishcouncil.org/">British Council â€” LearnEnglish Kids</a></li>
      <li><a target="_blank" rel="noreferrer" href="https://www.bbc.co.uk/learningenglish">BBC Learning English</a></li>
      <li><a target="_blank" rel="noreferrer" href="https://www.cambridgeenglish.org/learning-english/">Cambridge English â€” Learning</a></li>
      <li><a target="_blank" rel="noreferrer" href="https://www.oxfordowl.co.uk/">Oxford Owl â€” Reading</a></li>
      <li><a target="_blank" rel="noreferrer" href="https://www.starfall.com/">Starfall â€” Beginners</a></li>
    </ul>

    <hr class="hr">

    <h3>ğŸ™ï¸ PronunciaciÃ³n (futurista)</h3>
    <div class="mut">
      Esta web puede hablar (TTS) y escuchar (micrÃ³fono) si el navegador lo permite.
      Ideal para â€œinmersiÃ³nâ€ sin pagar apps caras.
    </div>

    <hr class="hr">

    <h3>ğŸš€ Roadmap (visiÃ³n Roblox)</h3>
    <ul class="list mut">
      <li>Web PWA (hoy): misiones + juegos + speaking.</li>
      <li>Mini mundo 3D en navegador (Three.js).</li>
      <li>Roblox/VR: misiones en un â€œDubai School Worldâ€.</li>
    </ul>
  </aside>
</div>

<script>
/* ===========================
   0) Utilities & Date
=========================== */
const today = new Date();
const dayKey = today.toISOString().slice(0,10);
document.getElementById("today").textContent =
  today.toLocaleDateString("es-ES",{weekday:"long",year:"numeric",month:"long",day:"numeric"});

const $ = (id)=>document.getElementById(id);

function show(view){
  ["viewLogin","viewHome","viewMap","viewArcade","viewParents"].forEach(v=>$(v).classList.add("hidden"));
  $(view).classList.remove("hidden");
}

/* ===========================
   1) Data model (Local)
=========================== */
function storeKey(code){ return `eq_user_${code.toUpperCase()}`; }

function loadUser(code){
  const raw = localStorage.getItem(storeKey(code));
  if(raw) return JSON.parse(raw);
  // Create new user
  const u = {
    code: code.toUpperCase(),
    createdAt: Date.now(),
    xp: 0,
    level: 1,
    streak: 0,
    lastDay: null,
    completedDays: {},
    wrongWords: {}, // {word: {count, lastWrongDay}}
  };
  localStorage.setItem(storeKey(code), JSON.stringify(u));
  return u;
}

function saveUser(u){
  localStorage.setItem(storeKey(u.code), JSON.stringify(u));
}

let USER = null;

/* ===========================
   2) Worlds & Missions
=========================== */
const WORLDS = [
  { id:"school", title:"School", desc:"Classroom, teacher, homework", emoji:"ğŸ«" },
  { id:"home", title:"Home", desc:"Family, routines, chores", emoji:"ğŸ " },
  { id:"city", title:"City", desc:"Directions, supermarket, transport", emoji:"ğŸ™ï¸" },
  { id:"friends", title:"Friends", desc:"Feelings, games, social talk", emoji:"ğŸ§‘â€ğŸ¤â€ğŸ§‘" },
];

const MISSIONS = {
  school: [
    { title:"In the classroom", phrases:[
      ["Can you repeat, please?","Â¿Puedes repetir, por favor?"],
      ["I donâ€™t understand.","No entiendo."],
      ["May I go to the bathroom?","Â¿Puedo ir al baÃ±o?"],
      ["What does this mean?","Â¿QuÃ© significa esto?"],
    ]},
  ],
  home: [
    { title:"Daily routine", phrases:[
      ["I wake up at 7.","Me despierto a las 7."],
      ["I brush my teeth.","Me cepillo los dientes."],
      ["I do my homework.","Hago mi tarea."],
      ["I go to bed early.","Me acuesto temprano."],
    ]},
  ],
  city: [
    { title:"At the supermarket", phrases:[
      ["How much is this?","Â¿CuÃ¡nto cuesta esto?"],
      ["Where is the milk?","Â¿DÃ³nde estÃ¡ la leche?"],
      ["Iâ€™d like some water, please.","Quisiera agua, por favor."],
      ["Thank you!","Â¡Gracias!"],
    ]},
  ],
  friends: [
    { title:"Making friends", phrases:[
      ["Hi, my name is ___.","Hola, mi nombre es ___."],
      ["Do you want to play?","Â¿Quieres jugar?"],
      ["Thatâ€™s awesome!","Â¡Eso es genial!"],
      ["See you tomorrow!","Â¡Nos vemos maÃ±ana!"],
    ]},
  ],
};
/* ===========================
   MAP: Fortnite-style POIs
=========================== */

// Real POIs (v1). Coordinates are relative to the 1100x700 canvas.
const POIS = [
  // Dubai
  { id:"dxb", name:"Dubai International Airport (DXB)", emoji:"âœˆï¸", city:"Dubai", minLevel:2, x:820, y:180, desc:"Check-in, security, gate, boarding." },
  { id:"metro", name:"Dubai Metro", emoji:"ğŸš‡", city:"Dubai", minLevel:2, x:720, y:270, desc:"Tickets, directions, stations, routes." },
  { id:"rtaTaxi", name:"RTA Taxi (Dubai)", emoji:"ğŸš•", city:"Dubai", minLevel:1, x:660, y:330, desc:"Go toâ€¦, stop, please, price." },
  { id:"dubaiMall", name:"Dubai Mall", emoji:"ğŸ¬", city:"Dubai", minLevel:1, x:610, y:390, desc:"Shopping, food, prices, asking for help." },
  { id:"downtown", name:"Downtown Dubai", emoji:"ğŸ™ï¸", city:"Dubai", minLevel:2, x:560, y:440, desc:"Directions, landmarks, meeting friends." },
  { id:"jbr", name:"JBR / The Beach", emoji:"ğŸ–ï¸", city:"Dubai", minLevel:3, x:740, y:470, desc:"Tourist talk, activities, safety rules." },
  { id:"sports", name:"Sports World", emoji:"âš½", city:"Dubai", minLevel:2, x:470, y:320, desc:"Sports verbs, teamwork, friendly talk." },

  // Abu Dhabi
  { id:"auh", name:"Zayed International Airport (AUH)", emoji:"âœˆï¸", city:"Abu Dhabi", minLevel:3, x:260, y:210, desc:"Travel missions, delays, help desk." },
  { id:"corniche", name:"Abu Dhabi Corniche", emoji:"ğŸ™ï¸", city:"Abu Dhabi", minLevel:2, x:320, y:320, desc:"City places, directions, plans." },
  { id:"adTaxi", name:"Abu Dhabi Taxi", emoji:"ğŸš•", city:"Abu Dhabi", minLevel:2, x:360, y:390, desc:"Transport phrases and polite requests." },
];

// Personal Home POI (created by user)
function getHomePOI(){
  const thumb = localStorage.getItem("eq_home_thumb"); // dataURL
  return {
    id:"myhome",
    name:"My Home (Personal)",
    emoji:"ğŸ ",
    city:"Personal",
    minLevel:0,
    x:160,
    y:520,
    desc:"Your room/home objects: bed, door, window, deskâ€¦",
    thumb
  };
}

let MAP_ZOOM = 1;

function canAccess(poi){
  if(!USER) return false;
  return (USER.level || 1) >= (poi.minLevel || 0);
}

function renderMap(){
  const layer = $("poiLayer");
  if(!layer) return;

  layer.innerHTML = "";

  // Always include personal POI first
  const all = [getHomePOI(), ...POIS];

  all.forEach(p=>{
    const locked = USER ? !canAccess(p) : true;
    const div = document.createElement("div");
    div.className = "poi" + (locked ? " locked" : "");
    div.style.left = p.x + "px";
    div.style.top = p.y + "px";

    const badge = locked ? "ğŸ”’" : "âœ…";
    div.innerHTML = `
      <div class="row" style="gap:8px; align-items:center;">
        <div style="font-size:16px">${p.emoji}</div>
        <div>
          <div class="name">${p.name}</div>
          <div class="mut" style="font-size:11px">${p.city} â€¢ L${p.minLevel}+ <span class="badge">${badge}</span></div>
        </div>
      </div>
    `;

    div.onclick = ()=> openPOI(p);
    layer.appendChild(div);
  });

  // Apply zoom
  $("mapCanvas").style.transform = `scale(${MAP_ZOOM})`;
  $("zoomLabel").textContent = Math.round(MAP_ZOOM*100) + "%";
}

function openPOI(p){
  const locked = !USER ? true : !canAccess(p);

  if(locked){
    $("poiPanel").innerHTML = `
      <b>${p.emoji} ${p.name}</b><br>
      <span class="pill">ğŸ”’ Locked</span>
      <div style="margin-top:8px" class="mut">
        Unlock at <b>Level ${p.minLevel}</b>.<br>
        Complete missions to gain XP.
      </div>
    `;
    return;
  }

  // If personal home exists, show thumbnail
  const thumbHTML = p.thumb ? `<img class="poiThumb" src="${p.thumb}" alt="My Home thumbnail">` : "";

  $("poiPanel").innerHTML = `
    <b>${p.emoji} ${p.name}</b> <span class="pill">âœ… Open</span><br>
    <div style="margin-top:8px" class="mut">${p.desc}</div>
    ${thumbHTML}
    <hr class="hr">
    <button class="primary" onclick="enterPOI('${p.id}')">â–¶ï¸ Enter</button>
  `;
}

function enterPOI(id){
  // For now, route to existing worlds as v1
  // Later we create dedicated missions per POI.
  if(id === "myhome"){
    // open "home" world mission
    show("viewHome");
    renderKPIs();
    openWorld("home");
    return;
  }
  if(id === "sports"){
    show("viewHome"); renderKPIs(); openWorld("friends");
    return;
  }
  // default: open city missions
  show("viewHome");
  renderKPIs();
  openWorld("city");
}

function initMapUI(){
  if(!$("btnAddHome")) return;

  $("btnAddHome").onclick = ()=>{
    if(!USER){ alert("Enter with a player code first."); return; }
    $("homePhotoInput").click();
  };

  $("homePhotoInput").onchange = (e)=>{
    const file = e.target.files && e.target.files[0];
    if(!file) return;
    const reader = new FileReader();
    reader.onload = ()=>{
      // Save thumbnail (data URL) locally (device only)
      localStorage.setItem("eq_home_thumb", reader.result);
      // Re-render map to show thumbnail inside POI panel if selected later
      renderMap();
      $("poiPanel").innerHTML = `<b>ğŸ  My Home (Personal)</b><br><span class="pill">âœ… Saved</span>
      <div class="mut" style="margin-top:8px">Photo saved on this device. Next step: comic-style filter + object missions.</div>
      <img class="poiThumb" src="${reader.result}" alt="My Home thumbnail">`;
    };
    reader.readAsDataURL(file);
  };

  $("zoomIn").onclick = ()=>{ MAP_ZOOM = Math.min(1.8, MAP_ZOOM + 0.1); renderMap(); };
  $("zoomOut").onclick = ()=>{ MAP_ZOOM = Math.max(0.7, MAP_ZOOM - 0.1); renderMap(); };
    // --- Drag to pan (Google Maps feel) ---
  const vp = $("mapViewport");
  let isDown = false;
  let startX = 0, startY = 0, scrollLeft = 0, scrollTop = 0;

  const down = (clientX, clientY)=>{
    isDown = true;
    vp.classList.add("dragging");
    startX = clientX;
    startY = clientY;
    scrollLeft = vp.scrollLeft;
    scrollTop = vp.scrollTop;
  };

  const move = (clientX, clientY)=>{
    if(!isDown) return;
    const dx = clientX - startX;
    const dy = clientY - startY;
    vp.scrollLeft = scrollLeft - dx;
    vp.scrollTop  = scrollTop  - dy;
  };

  const up = ()=>{
    isDown = false;
    vp.classList.remove("dragging");
  };

  // Mouse
  vp.addEventListener("mousedown", (e)=> down(e.clientX, e.clientY));
  window.addEventListener("mousemove", (e)=> move(e.clientX, e.clientY));
  window.addEventListener("mouseup", up);

  // Touch (mobile)
  vp.addEventListener("touchstart", (e)=>{
    const t = e.touches[0];
    down(t.clientX, t.clientY);
  }, {passive:true});

  vp.addEventListener("touchmove", (e)=>{
    const t = e.touches[0];
    move(t.clientX, t.clientY);
  }, {passive:true});

  vp.addEventListener("touchend", up, {passive:true});
  
    vp.addEventListener("wheel", (e)=>{
    e.preventDefault();
    const dir = Math.sign(e.deltaY);
    MAP_ZOOM = Math.max(0.7, Math.min(1.8, MAP_ZOOM + (dir > 0 ? -0.08 : 0.08)));
    renderMap();
  }, {passive:false});
}

/* ===========================
   3) Learning mechanics
   - XP + Streak
   - Spaced review (wrong words)
=========================== */
function updateStreak(u){
  if(!u.lastDay){
    u.streak = 0; u.lastDay = dayKey; return;
  }
  if(u.lastDay === dayKey) return;

  const prev = new Date(u.lastDay);
  const now = new Date(dayKey);
  const diffDays = Math.round((now - prev)/(1000*60*60*24));

  if(diffDays === 1) u.streak += 1;
  else u.streak = 0;

  u.lastDay = dayKey;
}

function awardXP(u, amount){
  u.xp += amount;
  const nextLevel = 1 + Math.floor(u.xp/200);
  u.level = Math.max(u.level, nextLevel);
}

function markDayDone(u){
  u.completedDays[dayKey] = true;
}

function todayDone(u){ return !!u.completedDays[dayKey]; }

function addWrongWord(u, word){
  const w = word.toLowerCase();
  const cur = u.wrongWords[w] || {count:0,lastWrongDay:null};
  cur.count += 1;
  cur.lastWrongDay = dayKey;
  u.wrongWords[w] = cur;
}

/* ===========================
   4) Audio: TTS + (optional) Speech Recognition
=========================== */
function speak(text){
  if(!window.speechSynthesis){
    alert("Este navegador no soporta audio.");
    return;
  }

  // cancelar audios previos
  speechSynthesis.cancel();

  const utt = new SpeechSynthesisUtterance(text);
  utt.lang = "en-US";
  utt.rate = 0.9;
  utt.pitch = 1;

  utt.onerror = (e)=>{
    console.error("TTS error", e);
    alert("Error reproduciendo audio");
  };

  speechSynthesis.speak(utt);
}

let recog = null;
function initSpeechRec(){
  const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
  if(!SR) return null;
  const r = new SR();
  r.lang = "en-US";
  r.interimResults = false;
  r.maxAlternatives = 1;
  return r;
}

/* ===========================
   5) Render Home
=========================== */
function renderWorlds(){
  const el = $("worlds");
  el.innerHTML = "";
  WORLDS.forEach(w=>{
    const d = document.createElement("div");
    d.className = "tile";
    d.innerHTML = `
      <div class="row" style="justify-content:space-between;">
        <div><div style="font-size:18px">${w.emoji} <b>${w.title}</b></div>
        <div class="mut">${w.desc}</div></div>
        <span class="pill">Open</span>
      </div>
    `;
    d.onclick = ()=> openWorld(w.id);
    el.appendChild(d);
  });
}

function renderKPIs(){
  $("who").textContent = `ğŸ® Player: ${USER.code}`;
  $("kXP").textContent = USER.xp;
  $("kStreak").textContent = USER.streak;
  $("kToday").textContent = todayDone(USER) ? "1/1" : "0/1";
  $("levelPill").textContent = `Level ${USER.level}`;
}

function openWorld(id){
  const m = MISSIONS[id][0];
  $("panel").innerHTML = missionHTML(id, m);
}

function missionHTML(worldId, m){
  const lines = m.phrases.map(([en,es],i)=>`
    <div class="card2" style="margin-top:10px;">
      <div class="row" style="justify-content:space-between;">
        <div>
          <div><b>${i+1}. ${en}</b></div>
          <div class="mut">${es}</div>
        </div>
        <div class="row">
          <button onclick="speak(${JSON.stringify(en)})">ğŸ”Š</button>
          <button onclick="practiceSpeak(${JSON.stringify(en)})">ğŸ™ï¸</button>
        </div>
      </div>
      <div class="mut" style="margin-top:8px;">Escribe la frase (sin mirar) y luego compara:</div>
      <div class="row">
        <input id="type_${worldId}_${i}" placeholder="Type here..." style="flex:1;min-width:220px;">
        <button class="primary" onclick="checkTyping('${worldId}',${i},${JSON.stringify(en)})">Check</button>
        <span id="res_${worldId}_${i}" class="pill">â€”</span>
      </div>
    </div>
  `).join("");

  return `
    <h3>ğŸ¯ MisiÃ³n: ${m.title}</h3>
    <div class="mut">Rutina sugerida: escucha â†’ repite â†’ escribe â†’ juego â†’ mini test.</div>
    ${lines}
    <hr class="hr">
    <button class="primary" onclick="finishMission()">âœ… Terminar misiÃ³n (gana XP)</button>
  `;
}

function normalize(s){
  return (s||"").toLowerCase().replace(/[^a-z0-9\s']/g,"").replace(/\s+/g," ").trim();
}

function checkTyping(worldId, i, target){
  const val = $("type_"+worldId+"_"+i).value;
  const ok = normalize(val) === normalize(target);
  const out = $("res_"+worldId+"_"+i);
  out.innerHTML = ok ? "<span class='msgOk'>Correct âœ…</span>" : "<span class='msgBad'>Try again</span>";
  if(!ok){
    // add 1-2 key words to review list
    const words = normalize(target).split(" ").filter(w=>w.length>3).slice(0,2);
    words.forEach(w=>addWrongWord(USER,w));
    saveUser(USER);
  }
}

function practiceSpeak(target){
  const SR = window.SpeechRecognition || window.webkitSpeechRecognition;

  if(!SR){
    alert("Este navegador no soporta reconocimiento de voz.");
    return;
  }

  navigator.mediaDevices.getUserMedia({ audio:true })
    .then(()=>{
      const rec = new SR();
      rec.lang = "en-US";
      rec.interimResults = false;
      rec.maxAlternatives = 1;

      rec.onresult = (e)=>{
        const said = e.results[0][0].transcript;
        const ok = normalize(said) === normalize(target);

        alert(
          ok
          ? "âœ… Excelente pronunciaciÃ³n"
          : `âŒ EscuchÃ©: "${said}"`
        );
      };

      rec.onerror = (e)=>{
        console.error(e);
        alert("Error de micrÃ³fono");
      };

      rec.start();
    })
    .catch(()=>{
      alert("Permiso de micrÃ³fono bloqueado");
    });
}

function finishMission(){
  if(todayDone(USER)){
    alert("Ya completaste la misiÃ³n de hoy âœ…");
    return;
  }
  updateStreak(USER);
  awardXP(USER, 50);
  markDayDone(USER);
  saveUser(USER);
  renderKPIs();
  $("panel").innerHTML = `<div class="card2"><b class="msgOk">Â¡MisiÃ³n completada! âœ…</b><div class="mut">Ganaste 50 XP. Vuelve maÃ±ana para mantener el streak.</div></div>`;
}

/* ===========================
   6) Smart Review (Spaced)
=========================== */
function smartReview(){
  const entries = Object.entries(USER.wrongWords || {});
  if(entries.length === 0){
    $("panel").innerHTML = `<div class="card2"><b>ğŸ” Repaso</b><div class="mut">No hay palabras pendientes. Â¡Vas muy bien! âœ…</div></div>`;
    return;
  }
  // sort by count desc
  entries.sort((a,b)=> (b[1].count||0)-(a[1].count||0));
  const top = entries.slice(0,8);

  $("panel").innerHTML = `
    <h3>ğŸ” Repaso inteligente</h3>
    <div class="mut">Estas son las palabras que mÃ¡s se te dificultan. Escucha y escribe.</div>
    ${top.map(([w,info],idx)=>`
      <div class="card2" style="margin-top:10px;">
        <div class="row" style="justify-content:space-between;">
          <div><b>${idx+1}. ${w}</b> <span class="pill">mistakes: ${info.count}</span></div>
          <button onclick="speak('${w}')">ğŸ”Š</button>
        </div>
        <div class="row" style="margin-top:8px;">
          <input id="rw_${idx}" placeholder="Type the word..." style="flex:1;min-width:220px;">
          <button class="primary" onclick="checkWord(${idx},'${w}')">Check</button>
          <span id="rwres_${idx}" class="pill">â€”</span>
        </div>
      </div>
    `).join("")}
  `;
}

function checkWord(idx, target){
  const val = $("rw_"+idx).value;
  const ok = normalize(val) === normalize(target);
  $("rwres_"+idx).innerHTML = ok ? "<span class='msgOk'>Correct âœ…</span>" : "<span class='msgBad'>Try again</span>";
  if(ok){
    // reduce mistake weight a bit
    const cur = USER.wrongWords[target];
    if(cur && cur.count>0) cur.count -= 1;
    saveUser(USER);
  }
}

/* ===========================
   7) Arcade Games
=========================== */
function arcadeMatch(){
  $("arcade").innerHTML = `
    <div class="card2">
      <h3>Match</h3>
      <div class="mut">Toca en orden: InglÃ©s â†’ EspaÃ±ol.</div>
      <div class="row" style="margin-top:10px;gap:8px;flex-wrap:wrap">
        ${["dog","book","house","perro","libro","casa"].map(x=>`<button onclick="pick('${x}')">${x}</button>`).join("")}
      </div>
      <div id="matchOut" class="mut" style="margin-top:10px;"></div>
    </div>
  `;
}
let first=null;
const pairs = {dog:"perro",book:"libro",house:"casa"};
function pick(x){
  const out = $("matchOut");
  if(!first){ first=x; out.textContent=`Elegiste: ${x}. Ahora toca su pareja.`; return; }
  const ok = pairs[first]===x || pairs[x]===first;
  out.innerHTML = ok ? "<b class='msgOk'>Â¡Match! âœ…</b>" : "<b class='msgBad'>No es pareja.</b>";
  first=null;
  if(!ok && USER){ addWrongWord(USER, (x.length>3?x:first)||x); saveUser(USER); }
}

function arcadeQuiz(){
  $("arcade").innerHTML = `
    <div class="card2">
      <h3>Quick Quiz</h3>
      <div class="mut">Responde rÃ¡pido (active recall).</div>
      <div style="margin-top:10px">
        <div class="mut">1) â€œHow are you?â€ significa:</div>
        <div class="row">
          <button class="good" onclick="q1(true)">Â¿CÃ³mo estÃ¡s?</button>
          <button class="bad" onclick="q1(false)">Â¿DÃ³nde estÃ¡s?</button>
          <span id="q1r" class="pill">â€”</span>
        </div>
      </div>
    </div>
  `;
}
function q1(ok){
  $("q1r").innerHTML = ok ? "<span class='msgOk'>Correct âœ…</span>" : "<span class='msgBad'>No</span>";
  if(!ok && USER){ addWrongWord(USER,"how"); addWrongWord(USER,"are"); saveUser(USER); }
}

function arcadeListening(){
  $("arcade").innerHTML = `
    <div class="card2">
      <h3>Listening Bingo</h3>
      <div class="mut">Toca ğŸ”Š, escucha y selecciona la palabra correcta.</div>
      <div class="row" style="margin-top:10px;">
        <button onclick="playBingo()">ğŸ”Š Play</button>
        <span class="pill" id="bingoHint">â€”</span>
      </div>
      <div class="row" style="margin-top:10px;">
        ${["milk","water","apple"].map(w=>`<button onclick="bingoPick('${w}')">${w}</button>`).join("")}
      </div>
      <div id="bingoOut" class="mut" style="margin-top:10px;"></div>
    </div>
  `;
}
let bingoTarget=null;
function playBingo(){
  const words=["milk","water","apple"];
  bingoTarget = words[Math.floor(Math.random()*words.length)];
  $("bingoHint").textContent="Escuchandoâ€¦";
  speak(bingoTarget);
}
function bingoPick(w){
  if(!bingoTarget){ $("bingoOut").innerHTML="<b class='msgBad'>Primero toca Play ğŸ”Š</b>"; return; }
  const ok = w===bingoTarget;
  $("bingoOut").innerHTML = ok ? "<b class='msgOk'>Â¡Correcto! âœ…</b>" : `<b class='msgBad'>No. Era: ${bingoTarget}</b>`;
  if(!ok && USER){ addWrongWord(USER,bingoTarget); saveUser(USER); }
  bingoTarget=null;
}

/* ===========================
   8) Parents view (simple)
=========================== */
function renderParents(){
  const keys = Object.keys(localStorage).filter(k=>k.startsWith("eq_user_"));
  if(keys.length===0){
    $("parents").innerHTML = `<div class="card2"><div class="mut">No hay usuarios guardados aÃºn.</div></div>`;
    return;
  }
  const users = keys.map(k=>JSON.parse(localStorage.getItem(k))).sort((a,b)=>b.xp-a.xp);
  $("parents").innerHTML = users.map(u=>{
    const days = Object.keys(u.completedDays||{}).length;
    const hard = Object.entries(u.wrongWords||{}).sort((a,b)=>b[1].count-a[1].count).slice(0,5);
    return `
      <div class="card2" style="margin-top:10px;">
        <div class="row" style="justify-content:space-between;">
          <div><b>${u.code}</b> <span class="pill">Level ${u.level}</span></div>
          <div class="row"><span class="pill">XP ${u.xp}</span><span class="pill">Streak ${u.streak}</span></div>
        </div>
        <div class="mut" style="margin-top:6px;">DÃ­as completados: <b>${days}</b></div>
        <div class="mut" style="margin-top:6px;">Palabras difÃ­ciles:
          ${hard.length? hard.map(([w,info])=>`<span class="pill">${w} (${info.count})</span>`).join(" ") : "<span class='pill'>â€”</span>"}
        </div>
      </div>
    `;
  }).join("");
}

/* ===========================
   9) Navigation buttons
=========================== */
$("btnHome").onclick = ()=> { if(USER){ show("viewHome"); renderKPIs(); } else show("viewLogin"); };
$("btnArcade").onclick = ()=> { show("viewArcade"); $("arcade").innerHTML = `<div class="card2" class="mut">Elige un juego arriba.</div>`; };
$("btnParents").onclick = ()=> { show("viewParents"); renderParents(); };
  $("btnMap").onclick = ()=>{
  show("viewMap");
  initMapUI();
  renderMap();
};


$("btnEnter").onclick = ()=>{
  const code = $("code").value.trim();
  if(!code){ alert("Escribe un cÃ³digo."); return; }
  USER = loadUser(code);
  renderWorlds();
  renderKPIs();
  $("panel").innerHTML = `<div class="card2"><b>Elige un mundo arriba</b><div class="mut">Luego presiona â€œEmpezar misiÃ³n de hoyâ€.</div></div>`;
  show("viewHome");
};

$("btnLogout").onclick = ()=>{
  USER = null;
  $("code").value="";
  show("viewLogin");
};

$("btnDaily").onclick = ()=>{
  // pick world based on simple rotation
  const w = WORLDS[today.getDay()%WORLDS.length].id;
  openWorld(w);
};

$("btnReview").onclick = ()=> smartReview();

// default view
show("viewLogin");
</script>
</body>
</html>
